<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Substation - IEC 61850 GOOSE Monitor</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1a1a1a; color: #fff; }
        .header { background: #2c3e50; padding: 20px; text-align: center; }
        .header h1 { color: #3498db; }
        .substation-diagram { background: #1a1a1a; margin: 20px; border-radius: 10px; padding: 20px; border: 2px solid #3498db; }
        .ied-status-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; padding: 20px; }
        .ied-card { background: #2c2c2c; border-radius: 10px; padding: 15px; border: 2px solid #444; }
        .ied-header { display: flex; align-items: center; margin-bottom: 10px; }
        .status-indicator { width: 12px; height: 12px; border-radius: 50%; margin-right: 10px; }
        .status-online { background: #27ae60; box-shadow: 0 0 10px #27ae60; }
        .status-offline { background: #e74c3c; }
        .ied-title { font-size: 16px; font-weight: bold; }
        .ied-data { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px; }
        .ied-data span { background: #3a3a3a; padding: 5px 8px; border-radius: 3px; }
        .fault-active { background: #e74c3c !important; color: #fff; animation: pulse 1s infinite; }
        .trip-active { background: #f39c12 !important; color: #fff; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .goose-flow { grid-column: 1 / -1; margin-top: 20px; }
        .goose-message { background: #34495e; padding: 15px; border-radius: 5px; margin-bottom: 10px; }
        .goose-header { color: #3498db; font-weight: bold; margin-bottom: 5px; }
        .communication-line { position: absolute; width: 2px; background: #3498db; height: 100px; left: 50%; transform: translateX(-50%); animation: dataFlow 2s infinite; }
        @keyframes dataFlow { 0% { opacity: 0.3; } 50% { opacity: 1; } 100% { opacity: 0.3; } }
        .network-info { grid-column: 1 / -1; background: #34495e; padding: 15px; border-radius: 5px; margin-top: 20px; }
        .control-panel { background: #2c3e50; padding: 20px; border-radius: 10px; margin: 20px; }
        .control-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .control-item { background: #34495e; padding: 15px; border-radius: 5px; }
        .control-item label { display: block; margin-bottom: 5px; font-weight: bold; }
        .control-item input, .control-item button { width: 100%; padding: 8px; border: none; border-radius: 3px; }
        .control-item input { background: #2c2c2c; color: #fff; }
        .control-item button { background: #3498db; color: #fff; cursor: pointer; }
        .control-item button:hover { background: #2980b9; }
        .fault-button { background: #e74c3c !important; }
        .fault-button:hover { background: #c0392b !important; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üè≠ Virtual Substation Monitor</h1>
        <p>132kV Transmission Line Bay - IEC 61850 GOOSE Communication</p>
        <div style="margin-top: 10px;">
            <a href="/" style="color: #3498db; text-decoration: none; margin-right: 20px;">üìä Single Line Diagram</a>
            <a href="/scada" style="color: #3498db; text-decoration: none;">üñ•Ô∏è SCADA MMS Interface</a>
        </div>
    </div>

    <!-- Substation Single Line Diagram -->
    <div class="substation-diagram">
        <svg width="100%" height="400" viewBox="0 0 1200 400">
            <!-- Incoming Line -->
            <line x1="50" y1="200" x2="200" y2="200" stroke="#3498db" stroke-width="4"/>
            <text x="60" y="190" fill="#fff" font-size="12">132kV Incoming</text>
            
            <!-- Circuit Breaker -->
            <g id="circuit-breaker">
                <rect x="200" y="180" width="60" height="40" fill="#2c3e50" stroke="#3498db" stroke-width="2" rx="5"/>
                <text x="215" y="205" fill="#fff" font-size="10">CB-01</text>
                <circle id="cb-indicator" cx="280" cy="200" r="8" fill="#27ae60"/>
            </g>
            
            <!-- Bus Bar -->
            <line x1="260" y1="200" x2="800" y2="200" stroke="#f39c12" stroke-width="8"/>
            <text x="500" y="190" fill="#fff" font-size="14">132kV Bus</text>
            
            <!-- Transformer -->
            <g id="transformer">
                <circle cx="600" cy="280" r="30" fill="none" stroke="#e74c3c" stroke-width="3"/>
                <circle cx="620" cy="280" r="25" fill="none" stroke="#e74c3c" stroke-width="3"/>
                <line x1="600" y1="200" x2="600" y2="250" stroke="#3498db" stroke-width="3"/>
                <line x1="620" y1="310" x2="620" y2="350" stroke="#3498db" stroke-width="3"/>
                <text x="570" y="370" fill="#fff" font-size="12">132/11kV</text>
            </g>
            
            <!-- Outgoing Lines -->
            <g id="outgoing-line1">
                <line x1="400" y1="200" x2="400" y2="120" stroke="#3498db" stroke-width="3"/>
                <line x1="400" y1="120" x2="500" y2="120" stroke="#3498db" stroke-width="3"/>
                <text x="420" y="115" fill="#fff" font-size="10">Line 1</text>
            </g>
            
            <g id="outgoing-line2">
                <line x1="700" y1="200" x2="700" y2="120" stroke="#3498db" stroke-width="3"/>
                <line x1="700" y1="120" x2="800" y2="120" stroke="#3498db" stroke-width="3"/>
                <text x="720" y="115" fill="#fff" font-size="10">Line 2</text>
            </g>
            
            <!-- Protection Relay -->
            <g id="protection-relay">
                <rect x="300" y="250" width="80" height="50" fill="#34495e" stroke="#3498db" stroke-width="2" rx="5"/>
                <text x="315" y="270" fill="#fff" font-size="10">PROT_REL</text>
                <text x="325" y="285" fill="#fff" font-size="10">001</text>
                <circle id="relay-status-svg" cx="360" cy="260" r="5" fill="#27ae60"/>
            </g>
            
            <!-- Current Flow Animation -->
            <g id="current-flow">
                <circle id="flow1" cx="150" cy="200" r="3" fill="#f1c40f" opacity="0.8">
                    <animate attributeName="cx" values="150;750" dur="2s" repeatCount="indefinite"/>
                </circle>
                <circle id="flow2" cx="100" cy="200" r="3" fill="#f1c40f" opacity="0.6">
                    <animate attributeName="cx" values="100;700" dur="2s" repeatCount="indefinite"/>
                </circle>
            </g>
            
            <!-- Measurements -->
            <g id="measurements">
                <rect x="900" y="150" width="250" height="200" fill="#2c2c2c" stroke="#444" stroke-width="1" rx="5"/>
                <text x="920" y="170" fill="#3498db" font-size="14" font-weight="bold">Live Measurements</text>
                <text x="920" y="195" fill="#fff" font-size="12">Voltage: <tspan id="svg-voltage">132.0 kV</tspan></text>
                <text x="920" y="215" fill="#fff" font-size="12">Current: <tspan id="svg-current">450 A</tspan></text>
                <text x="920" y="235" fill="#fff" font-size="12">Frequency: <tspan id="svg-frequency">50.00 Hz</tspan></text>
                <text x="920" y="255" fill="#fff" font-size="12">Power: <tspan id="svg-power">59.4 MW</tspan></text>
                <text x="920" y="285" fill="#e74c3c" font-size="12" id="svg-fault-status">Status: NORMAL</text>
                <text x="920" y="305" fill="#f39c12" font-size="12" id="svg-trip-status">Trip: NO</text>
            </g>
        </svg>
    </div>
    
    <!-- IED Status Panels -->
    <div class="ied-status-grid">
        <div class="ied-card">
            <div class="ied-header">
                <div class="status-indicator" id="relay-status"></div>
                <div class="ied-title">üõ°Ô∏è PROT_REL_001</div>
            </div>
            <div class="ied-data">
                <span>V: <span id="voltage">132.0 kV</span></span>
                <span>I: <span id="current">450 A</span></span>
                <span>F: <span id="frequency">50.00 Hz</span></span>
                <span class="fault-indicator" id="fault-item">‚ö° <span id="fault-status">NORMAL</span></span>
            </div>
        </div>
        
        <div class="ied-card">
            <div class="ied-header">
                <div class="status-indicator" id="breaker-status"></div>
                <div class="ied-title">üîå CB_LINE_01_001</div>
            </div>
            <div class="ied-data">
                <span>Position: <span id="breaker-position">CLOSED</span></span>
                <span>Trip RX: <span id="trip-received">NO</span></span>
                <span>StNum: <span id="state-number">0</span></span>
                <span>SqNum: <span id="sequence-number">0</span></span>
            </div>
        </div>
        
        <div class="ied-card">
            <div class="ied-header">
                <div class="status-indicator status-online"></div>
                <div class="ied-title">üíª HMI/SCADA</div>
            </div>
            <div class="ied-data">
                <span>MMS: Connected</span>
                <span>Port: 102</span>
                <span>Reports: Active</span>
                <span>Last: <span id="last-update">--:--:--</span></span>
            </div>
        </div>
    </div>

        <!-- Simulation Control Panel -->
        <div class="control-panel">
            <h3>üéõÔ∏è Substation Simulation Controls</h3>
            <div class="control-grid">
                <div class="control-item">
                    <label>Voltage L1 (kV)</label>
                    <input type="number" id="voltage-input" value="132.0" step="0.1" min="120" max="145">
                    <button onclick="updateVoltage()">Update</button>
                </div>
                <div class="control-item">
                    <label>Current L1 (A)</label>
                    <input type="number" id="current-input" value="450" step="10" min="0" max="3000">
                    <button onclick="updateCurrent()">Update</button>
                </div>
                <div class="control-item">
                    <label>Frequency (Hz)</label>
                    <input type="number" id="frequency-input" value="50.0" step="0.01" min="49.5" max="50.5">
                    <button onclick="updateFrequency()">Update</button>
                </div>
                <div class="control-item">
                    <label>Fault Simulation</label>
                    <button id="fault-button" onclick="toggleFault()">Trigger Fault</button>
                </div>
                <div class="control-item">
                    <label>Circuit Breaker</label>
                    <button id="breaker-button" onclick="toggleBreaker()">Toggle Breaker</button>
                </div>
                <div class="control-item">
                    <label>Trip Command</label>
                    <button id="trip-button" onclick="sendTrip()">Send Trip</button>
                </div>
                <div class="control-item">
                    <label>Fault Current (A)</label>
                    <input type="number" id="fault-current-input" value="0" step="100" min="0" max="5000">
                    <button onclick="updateFaultCurrent()">Update</button>
                </div>
                <div class="control-item">
                    <label>Manual Trip</label>
                    <button id="manual-trip-button" onclick="toggleManualTrip()">Enable Trip</button>
                </div>
            </div>
        </div>

        <!-- Network Information -->
        <div class="network-info">
            <h3>üåê Network Configuration</h3>
            <p><strong>Process Bus:</strong> 192.168.10.0/24 - GOOSE Communication (AppId: 4096)</p>
            <p><strong>Station Bus:</strong> 192.168.20.0/24 - MMS Communication (Port: 102)</p>
            <p><strong>GOOSE Control Block:</strong> simpleIOGenericIO/LLN0$GO$gcbEvents</p>
            <p><strong>Dataset:</strong> Events3 (8 values: SPCSO1-4 with stVal+q)</p>
        </div>
    </div>

    <script>
        const ws = new WebSocket(`ws://${window.location.host}`);
        
        ws.onmessage = (event) => {
            const message = JSON.parse(event.data);
            if (message.type === 'iedUpdate') {
                updateDisplay(message.data);
            }
        };

        function updateDisplay(data) {
            // Protection Relay Status
            const relayStatus = document.getElementById('relay-status');
            const relayStatusSvg = document.getElementById('relay-status-svg');
            const isOnline = data.protectionRelay.status === 'online';
            relayStatus.className = `status-indicator ${isOnline ? 'status-online' : 'status-offline'}`;
            relayStatusSvg.setAttribute('fill', isOnline ? '#27ae60' : '#e74c3c');
            
            // Update measurements
            document.getElementById('voltage').textContent = `${data.protectionRelay.voltage.toFixed(1)} kV`;
            document.getElementById('current').textContent = `${data.protectionRelay.current.toFixed(0)} A`;
            document.getElementById('frequency').textContent = `${data.protectionRelay.frequency.toFixed(3)} Hz`;
            
            // SVG measurements
            document.getElementById('svg-voltage').textContent = `${data.protectionRelay.voltage.toFixed(1)} kV`;
            document.getElementById('svg-current').textContent = `${data.protectionRelay.current.toFixed(0)} A`;
            document.getElementById('svg-frequency').textContent = `${data.protectionRelay.frequency.toFixed(3)} Hz`;
            document.getElementById('svg-power').textContent = `${(data.protectionRelay.voltage * data.protectionRelay.current * Math.sqrt(3) / 1000).toFixed(1)} MW`;
            
            // Circuit Breaker
            const breakerStatus = document.getElementById('breaker-status');
            const cbIndicator = document.getElementById('cb-indicator');
            const cbOnline = data.circuitBreaker.status === 'online';
            breakerStatus.className = `status-indicator ${cbOnline ? 'status-online' : 'status-offline'}`;
            
            const breakerOpen = data.protectionRelay.breakerStatus;
            document.getElementById('breaker-position').textContent = breakerOpen ? 'OPEN' : 'CLOSED';
            cbIndicator.setAttribute('fill', breakerOpen ? '#e74c3c' : '#27ae60');
            
            // Current flow animation
            const currentFlow = document.getElementById('current-flow');
            currentFlow.style.display = (data.protectionRelay.current > 0 && !breakerOpen) ? 'block' : 'none';
            
            // Fault Status
            const faultItem = document.getElementById('fault-item');
            const faultStatus = document.getElementById('fault-status');
            const svgFaultStatus = document.getElementById('svg-fault-status');
            if (data.protectionRelay.faultDetected) {
                faultItem.style.color = '#e74c3c';
                faultStatus.textContent = 'üö® FAULT';
                svgFaultStatus.textContent = 'Status: ‚ö° FAULT DETECTED';
                svgFaultStatus.setAttribute('fill', '#e74c3c');
            } else {
                faultItem.style.color = '#27ae60';
                faultStatus.textContent = 'NORMAL';
                svgFaultStatus.textContent = 'Status: NORMAL';
                svgFaultStatus.setAttribute('fill', '#27ae60');
            }
            
            // Trip Status
            const svgTripStatus = document.getElementById('svg-trip-status');
            if (data.protectionRelay.tripCommand) {
                svgTripStatus.textContent = 'Trip: ‚ö° ISSUED';
                svgTripStatus.setAttribute('fill', '#f39c12');
            } else {
                svgTripStatus.textContent = 'Trip: NO';
                svgTripStatus.setAttribute('fill', '#95a5a6');
            }
            
            document.getElementById('trip-received').textContent = data.circuitBreaker.tripReceived ? '‚ö° YES' : 'NO';
            document.getElementById('state-number').textContent = data.circuitBreaker.stateNumber;
            document.getElementById('sequence-number').textContent = data.circuitBreaker.sequenceNumber;
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
        }

        ws.onopen = () => {
            console.log('Connected to substation monitor');
        };

        ws.onclose = () => {
            console.log('Disconnected from substation monitor');
        };

        // Simulation control functions
        function updateVoltage() {
            const voltage = parseFloat(document.getElementById('voltage-input').value);
            sendCommand('updateVoltage', { voltage });
        }

        function updateCurrent() {
            const current = parseFloat(document.getElementById('current-input').value);
            sendCommand('updateCurrent', { current });
        }

        function updateFrequency() {
            const frequency = parseFloat(document.getElementById('frequency-input').value);
            sendCommand('updateFrequency', { frequency });
        }

        function toggleFault() {
            const button = document.getElementById('fault-button');
            const isFault = button.textContent === 'Clear Fault';
            sendCommand('toggleFault', { active: !isFault });
            button.textContent = isFault ? 'Trigger Fault' : 'Clear Fault';
            button.className = isFault ? '' : 'fault-button';
        }

        function toggleBreaker() {
            const button = document.getElementById('breaker-button');
            const isOpen = button.textContent === 'Close Breaker';
            sendCommand('toggleBreaker', { open: !isOpen });
            button.textContent = isOpen ? 'Open Breaker' : 'Close Breaker';
        }

        function sendTrip() {
            sendCommand('sendTrip', {});
        }

        function updateFaultCurrent() {
            const faultCurrent = parseFloat(document.getElementById('fault-current-input').value);
            sendCommand('updateFaultCurrent', { faultCurrent });
        }

        function toggleManualTrip() {
            const button = document.getElementById('manual-trip-button');
            const isActive = button.textContent === 'Disable Trip';
            sendCommand('toggleManualTrip', { active: !isActive });
            button.textContent = isActive ? 'Enable Trip' : 'Disable Trip';
        }

        function sendCommand(command, data) {
            if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'command', command, data }));
            }
        }
    </script>
</body>
</html>